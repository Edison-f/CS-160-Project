<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SortSmart</title>
    <meta property="og:title" content="SortSmart" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <meta property="twitter:card" content="summary_large_image" />

    <style data-tag="reset-style-sheet">
      html {  line-height: 1.15;}body {  margin: 0;}* {  box-sizing: border-box;  border-width: 0;  border-style: solid;  -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption {  margin: 0;  padding: 0;}button {  background-color: transparent;}button,input,optgroup,select,textarea {  font-family: inherit;  font-size: 100%;  line-height: 1.15;  margin: 0;}button,select {  text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] {  -webkit-appearance: button;  -moz-appearance: button;  appearance: button;  color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner {  border-style: none;  padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus {  outline: 1px dotted ButtonText;}a {  color: inherit;  text-decoration: inherit;}pre {  white-space: normal;}input {  padding: 2px 4px;}img {  display: block;}details {  display: block;  margin: 0;  padding: 0;}summary::-webkit-details-marker {  display: none;}[data-thq="accordion"] [data-thq="accordion-content"] {  max-height: 0;  overflow: hidden;  transition: max-height 0.3s ease-in-out;  padding: 0;}[data-thq="accordion"] details[data-thq="accordion-trigger"][open] + [data-thq="accordion-content"] {  max-height: 1000vh;}details[data-thq="accordion-trigger"][open] summary [data-thq="accordion-icon"] {  transform: rotate(180deg);}html { scroll-behavior: smooth  }
    </style>
    <style data-tag="default-style-sheet">
      html {
        font-family: Inter;
        font-size: 1rem;
      }

      body {
        font-weight: 400;
        font-style:normal;
        text-decoration: undefined;
        text-transform: undefined;
        letter-spacing: normal;
        line-height: 1.55;
        color: var(--color-on-surface);
        background: var(--color-surface);

        fill: var(--color-on-surface);
      }
    </style>
    <link
      rel="stylesheet"
      href="https://unpkg.com/animate.css@4.1.1/animate.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap"
      data-tag="font"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@teleporthq/teleport-custom-scripts/dist/style.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
  </head>
  <body>
    <link rel="stylesheet" href="./style.css" />
    <div>
      <link href="./index.css" rel="stylesheet" />

      <div class="home-container1">
        <navigation-wrapper class="navigation-wrapper">
          <!--Navigation component-->
          <div class="navigation-container1">
            <nav
              id="main-navigation"
              aria-label="Main navigation"
              class="navigation"
            >
              <div class="navigation__container">
                <a href="index.html">
                  <div aria-label="SortSmart - Home" class="navigation__logo">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="32"
                      height="32"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                      class="navigation__logo-icon"
                    >
                      <g
                        fill="none"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                      >
                        <path
                          d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881a1.79 1.79 0 0 1-.004-1.784L7.196 9.5M11 19h8.203a1.83 1.83 0 0 0 1.556-.89a1.78 1.78 0 0 0 0-1.775l-1.226-2.12"
                        ></path>
                        <path
                          d="m14 16l-3 3l3 3m-5.707-8.404L7.196 9.5L3.1 10.598m6.244-4.787l1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.78 1.78 0 0 1 1.546.888l3.943 6.843"
                        ></path>
                        <path d="m13.378 9.633l4.096 1.098l1.097-4.096"></path>
                      </g>
                    </svg>
                    <span class="navigation__logo-text">SortSmart</span>
                  </div>
                </a>
                <button
                  id="navigation-toggle"
                  aria-expanded="false"
                  aria-controls="navigation-menu"
                  aria-label="Toggle navigation menu"
                  class="navigation__toggle"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    class="navigation-navigationtoggle-icon1 navigation__toggle-icon--open"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 5h16M4 12h16M4 19h16"
                    ></path></svg
                  ><svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    class="navigation-navigationtoggle-icon2"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1zm-5.5-3.5l-5 5m0-5l5 5"
                    ></path>
                  </svg>
                </button>
                <div id="navigation-menu" class="navigation__menu">
                  <ul class="navigation__list">
                    <li class="navigation__item">
                      <a href="categories.html">
                        <div class="navigation__link">
                          <span>Recycling Categories</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="#locations">
                        <div class="navigation__link">
                          <span>Find Nearby Locations</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="resources.html">
                        <div class="navigation__link">
                          <span>Resource Links</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="#about">
                        <div class="navigation__link">
                          <span>Photo Recognition</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item navigation__item--cta">
                      <a href="#search">
                        <div class="navigation__cta btn btn-primary">
                          <span>AI Chatbot</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </nav>
            <div class="navigation-container2">
              <div class="navigation-container3">
                <style>
                  @media (prefers-reduced-motion: reduce) {
                  .navigation, .navigation__logo, .navigation__toggle, .navigation__link, .navigation__menu, .navigation__toggle-icon, .navigation__logo-icon {
                    transition: none;
                  }
                  .navigation__link::after {
                    transition: none;
                  }
                  }
                </style>
              </div>
            </div>
            <div class="navigation-container4">
              <div class="navigation-container5">
                <script defer="" data-name="navigation">
                  document.addEventListener('DOMContentLoaded', function() {
                    (function(){
                      // Navigation Toggle Functionality
                      const navigationToggle = document.getElementById("navigation-toggle")
                      const navigationMenu = document.getElementById("navigation-menu")
                      const navigation = document.getElementById("main-navigation")

                      // Toggle mobile menu
                      if (navigationToggle && navigationMenu) {
                        navigationToggle.addEventListener("click", function () {
                          const isExpanded =
                            navigationToggle.getAttribute("aria-expanded") === "true"
                          navigationToggle.setAttribute("aria-expanded", !isExpanded)
                          navigationMenu.classList.toggle("navigation__menu--open")

                          // Prevent body scroll when menu is open
                          document.body.style.overflow = !isExpanded ? "hidden" : ""
                        })

                        // Close menu when clicking backdrop
                        navigationMenu.addEventListener("click", function (e) {
                          if (
                            e.target === navigationMenu &&
                            navigationMenu.classList.contains("navigation__menu--open")
                          ) {
                            navigationToggle.setAttribute("aria-expanded", "false")
                            navigationMenu.classList.remove("navigation__menu--open")
                            document.body.style.overflow = ""
                          }
                        })

                        // Close menu when clicking a link
                        const navigationLinks = navigationMenu.querySelectorAll(".navigation__link")
                        navigationLinks.forEach(function (link) {
                          link.addEventListener("click", function () {
                            if (window.innerWidth <= 991) {
                              navigationToggle.setAttribute("aria-expanded", "false")
                              navigationMenu.classList.remove("navigation__menu--open")
                              document.body.style.overflow = ""
                            }
                          })
                        })

                        // Handle resize to reset menu state
                        let resizeTimer
                        window.addEventListener("resize", function () {
                          clearTimeout(resizeTimer)
                          resizeTimer = setTimeout(function () {
                            if (window.innerWidth > 991) {
                              navigationToggle.setAttribute("aria-expanded", "false")
                              navigationMenu.classList.remove("navigation__menu--open")
                              document.body.style.overflow = ""
                            }
                          }, 250)
                        })
                      }

                      // Add scroll enhancement class
                      let lastScroll = 0
                      window.addEventListener("scroll", function () {
                        const currentScroll = window.pageYOffset

                        if (currentScroll > 50) {
                          navigation.classList.add("navigation--scrolled")
                        } else {
                          navigation.classList.remove("navigation--scrolled")
                        }

                        lastScroll = currentScroll
                      })

                      // Handle keyboard navigation (Escape key to close menu)
                      document.addEventListener("keydown", function (e) {
                        if (
                          e.key === "Escape" &&
                          navigationMenu.classList.contains("navigation__menu--open")
                        ) {
                          navigationToggle.setAttribute("aria-expanded", "false")
                          navigationMenu.classList.remove("navigation__menu--open")
                          document.body.style.overflow = ""
                          navigationToggle.focus()
                        }
                      })
                    })()
                  });
                </script>
              </div>
            </div>
          </div>
        </navigation-wrapper>
        <div class="home-container2">
          <div class="home-container3">
            <style>
              @media (prefers-reduced-motion: reduce) {
              * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
              }
              }
            </style>
          </div>
        </div>
        <section id="hero-section" class="hero-section">
          <div class="hero-container">
            <div class="hero-content">
              <div class="hero-headline">
                <h1>SortSmart</h1>
                <p>
                  Clear, confident recycling guidance for campuses and
                  communities.
                </p>
              </div>
              <div
                role="search"
                aria-label="Search recycling items"
                class="hero-search"
              >
                <!-- ZIP lookup -->
                <form id="zip-form" class="lookup-form" style="margin-bottom: .5rem;">
                  <label for="zip-input" class="sr-only">Enter ZIP code</label>
                  <input
                    id="zip-input"
                    name="zip"
                    inputmode="numeric"
                    pattern="[0-9]{5}"
                    maxlength="5"
                    placeholder="Enter 5-digit ZIP (CA only)"
                    aria-label="Enter 5-digit ZIP code"
                  />
                  <button type="submit" class="btn btn-outline btn-sm">Set ZIP</button>
                  <span id="jurisdiction-badge" class="badge" style="display:none; color:#000;"></span>
                  <button id="clear-jurisdiction" type="button" class="btn btn-link btn-sm" style="display:none;">Clear</button>
                </form>

                <!-- Map container -->
                <div id="locations-map" style="display:none; width:100%; height:400px; margin-top:1rem; border-radius:8px; border:1px solid var(--color-border);"></div>

                <!-- Item search -->
                <form id="hero-search-form" class="search-form">
                  <input
                    type="search"
                    id="hero-search-input"
                    placeholder="Search any item (e.g., coffee cup, battery, cardboard...)"
                    aria-label="Search for recycling guidance"
                    class="search-input"
                  />
                  <button
                    type="submit"
                    aria-label="Search"
                    class="search-submit btn btn-primary"
                  >
                    <!-- ...existing icon... -->
                    <span>Search</span>
                  </button>
                </form>

                <!-- Results -->
                <div id="search-results" class="content-block" style="margin-top: .75rem; display:none;">
                  <h2 style="margin-bottom: .5rem;">Results</h2>
                  <ul id="results-list" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
              </div>
              <div class="hero-categories">
                <div class="category-card">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                  >
                    <g
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881a1.79 1.79 0 0 1-.004-1.784L7.196 9.5M11 19h8.203a1.83 1.83 0 0 0 1.556-.89a1.78 1.78 0 0 0 0-1.775l-1.226-2.12"
                      ></path>
                      <path
                        d="m14 16l-3 3l3 3m-5.707-8.404L7.196 9.5L3.1 10.598m6.244-4.787l1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.78 1.78 0 0 1 1.546.888l3.943 6.843"
                      ></path>
                      <path d="m13.378 9.633l4.096 1.098l1.097-4.096"></path>
                    </g>
                  </svg>
                  <div class="category-info">
                    <h3>Material Categories</h3>
                    <p>Browse by material type</p>
                  </div>
                </div>
                <div class="category-card">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                  >
                    <g
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z"
                      ></path>
                      <circle cx="12" cy="13" r="3"></circle>
                    </g>
                  </svg>
                  <div class="category-info">
                    <h3>Upload Photo</h3>
                    <p>Instant image recognition</p>
                  </div>
                </div>
                <div class="category-card">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0zm.894.211v15M9 3.236v15"
                    ></path>
                  </svg>
                  <div class="category-info">
                    <h3>ZIP Lookup</h3>
                    <p>Find nearby drop-off sites</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="hero-image-panel">
              <div class="image-backplate">
                <img
                  src="https://images.pexels.com/photos/6591427/pexels-photo-6591427.jpeg?auto=compress&amp;cs=tinysrgb&amp;w=1500"
                  alt="Volunteers organize recyclables into glass, paper, and plastic bins to promote eco-friendly practices"
                  loading="eager"
                />
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </body>
  <script>
    (function(){
      const ZIP_STORAGE_KEY = 'sortsmart.jurisdiction';
      const zipForm = document.getElementById('zip-form');
      const zipInput = document.getElementById('zip-input');
      const badge = document.getElementById('jurisdiction-badge');
      const clearBtn = document.getElementById('clear-jurisdiction');

      const searchForm = document.getElementById('hero-search-form');
      const searchInput = document.getElementById('hero-search-input');
      const resultsWrap = document.getElementById('search-results');
      const resultsList = document.getElementById('results-list');

      // Ensure the displayed/stored county includes the word "County"
      function ensureCountySuffix(name) {
        if (!name) return name;
        const trimmed = String(name).trim();
        return /\bcounty$/i.test(trimmed) ? trimmed : trimmed + ' County';
      }

      function getStoredJurisdiction() {
        try { return JSON.parse(localStorage.getItem(ZIP_STORAGE_KEY) || 'null'); }
        catch { return null; }
      }
      function setStoredJurisdiction(obj) {
        localStorage.setItem(ZIP_STORAGE_KEY, JSON.stringify(obj));
      }
      function clearStoredJurisdiction() {
        localStorage.removeItem(ZIP_STORAGE_KEY);
      }
      function renderBadge(j) {
        const baseName = j && (j.county_name || j.jurisdiction_name);
        const name = baseName ? ensureCountySuffix(baseName) : null;
        if (name) {
          badge.style.display = '';
          clearBtn.style.display = '';
          badge.textContent = name + ' (' + (j.zip5 || '') + ')';
        } else {
          badge.style.display = 'none';
          clearBtn.style.display = 'none';
          badge.textContent = '';
        }
      }

      // Map initialization
      const mapContainer = document.getElementById('locations-map');
      let map = null;
      let markers = [];

      function initMap() {
        if (map) return;
        mapContainer.style.display = 'block';
        map = L.map('locations-map').setView([37.7749, -122.4194], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
      }

      function clearMap() {
        if (map) {
          markers.forEach(marker => map.removeLayer(marker));
          markers = [];
        }
      }

      async function geocodeAddress(address1, city, state, postalCode) {
        const addressParts = [];
        if (address1) addressParts.push(address1);
        if (city) addressParts.push(city);
        if (state) addressParts.push(state);
        if (postalCode) addressParts.push(postalCode);
        const fullAddress = addressParts.join(', ');
        
        if (!fullAddress) return null;
        
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`,
            {
              headers: {
                'User-Agent': 'SortSmart Recycling App'
              }
            }
          );
          const data = await response.json();
          if (data && data.length > 0) {
            return {
              latitude: parseFloat(data[0].lat),
              longitude: parseFloat(data[0].lon)
            };
          }
        } catch (err) {
          console.error('Geocoding error:', err);
        }
        return null;
      }

      async function loadLocationsOnMap() {
        try {
          const storedJurisdiction = getStoredJurisdiction();
          const zip = storedJurisdiction?.zip5 || '';
          const url = zip ? `/api/nearby_locations?zip=${encodeURIComponent(zip)}` : '/api/nearby_locations';
          const res = await fetch(url);
          if (!res.ok) throw new Error('Failed to load locations');
          const locations = await res.json();
          
          if (!map) initMap();
          clearMap();
          
          const bounds = [];
          
          for (const loc of locations) {
            let lat = loc.latitude;
            let lng = loc.longitude;
            
            if (!lat || !lng || lat === 0 || lng === 0) {
              const coords = await geocodeAddress(loc.address1, loc.city, loc.state, loc.postal_code);
              if (coords) {
                lat = coords.latitude;
                lng = coords.longitude;
              } else {
                continue;
              }
            }
            
            const marker = L.marker([lat, lng]).addTo(map);
            const popupContent = `
              <strong>${loc.name || 'Location'}</strong><br>
              ${loc.address1 ? loc.address1 + '<br>' : ''}
              ${loc.city ? loc.city + ', ' : ''}${loc.state || ''} ${loc.postal_code || ''}<br>
              ${loc.phone ? 'Phone: ' + loc.phone + '<br>' : ''}
              ${loc.hours ? 'Hours: ' + loc.hours + '<br>' : ''}
              ${loc.website ? '<a href="' + loc.website + '" target="_blank">Website</a>' : ''}
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);
            bounds.push([lat, lng]);
            
            await new Promise(resolve => setTimeout(resolve, 200));
          }
          
          if (bounds.length === 0) {
            map.setView([37.7749, -122.4194], 6);
          } else {
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        } catch (err) {
          console.error('Error loading locations:', err);
        }
      }

      // Init from storage
      const initJ = getStoredJurisdiction();
      if (initJ) {
        renderBadge(initJ);
        loadLocationsOnMap();
      }

      // ZIP form submit
      if (zipForm) {
        zipForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const zip = (zipInput.value || '').trim();
          if (!/^[0-9]{5}$/.test(zip)) {
            alert('Please enter a valid 5-digit ZIP.');
            return;
          }
          try {
            const res = await fetch('/api/zip_lookup?zip=' + encodeURIComponent(zip));
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || 'ZIP not found');
            }
            const data = await res.json();
            // Normalize county/jurisdiction name to always include "County"
            if (data.county_name) data.county_name = ensureCountySuffix(data.county_name);
            if (data.jurisdiction_name) data.jurisdiction_name = ensureCountySuffix(data.jurisdiction_name);
            setStoredJurisdiction(data);
            renderBadge(data);
            loadLocationsOnMap();
          } catch (err) {
            alert(err.message || 'Failed to look up ZIP.');
          }
        });
      }

      // Clear jurisdiction
      clearBtn.addEventListener('click', () => {
        clearStoredJurisdiction();
        renderBadge(null);
        if (map) {
          clearMap();
          map.remove();
          map = null;
          mapContainer.style.display = 'none';
        }
      });

      // Render results
      function renderResults(items) {
        resultsList.innerHTML = '';
        if (!items || !items.length) {
          resultsList.innerHTML = '<li style="padding:.5rem 0; color: var(--color-on-surface-secondary);">No results.</li>';
        } else {
          items.forEach(row => {
            const name = row.name;
            const stream = row.stream || '';
            const localized = row.is_localized ? ' (localized)' : ' (default)';
            const instructions = row.instructions || '';
            const li = document.createElement('li');
            li.style.padding = '.5rem 0';
            li.style.borderBottom = '1px solid var(--color-border)';
            li.innerHTML = `
              <strong>${name}</strong>
              <div style="font-size:.9rem; color: var(--color-on-surface-secondary);">
                Stream: <strong>${stream || 'n/a'}</strong>${stream ? localized : ''}
                ${instructions ? `<div style="margin-top:2px;">${instructions}</div>` : ''}
              </div>
            `;
            resultsList.appendChild(li);
          });
        }
        resultsWrap.style.display = '';
      }

      // Search submit
      if (searchForm) {
        searchForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const q = (searchInput.value || '').trim();
          if (!q) return;
          const j = getStoredJurisdiction();
          const params = new URLSearchParams({ q });
          if (j && (j.county_name || j.jurisdiction_name)) {
            const selectedCounty = ensureCountySuffix(j.county_name || j.jurisdiction_name);
            params.set('county_name', selectedCounty);
            params.set('state', j.state || 'CA');
          }
          try {
            const res = await fetch('/api/item_search?' + params.toString());
            const data = await res.json();
            renderResults(data);
          } catch {
            resultsList.innerHTML = '<li style="padding:.5rem 0;">Failed to search.</li>';
            resultsWrap.style.display = '';
          }
        });
      }
    })();
  </script>
</html>
