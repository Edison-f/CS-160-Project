<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Recycling categories — SortSmart</title>
    <meta property="og:title" content="Recycling categories — SortSmart" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <meta property="twitter:card" content="summary_large_image" />
    <link rel="stylesheet" href="./style.css" />
    <link href="./index.css" rel="stylesheet" />
    <style>
      .resources-container.categories-layout {
        grid-template-columns: 1fr;
      }
      .home-container1 {
        min-height: auto;
      }
    </style>
  </head>
  <body>
    <div>
      <div class="home-container1">
        <navigation-wrapper class="navigation-wrapper">
          <div class="navigation-container1">
            <nav
              id="main-navigation"
              aria-label="Main navigation"
              class="navigation"
            >
              <div class="navigation__container">
                <a href="index.html">
                  <div aria-label="SortSmart - Home" class="navigation__logo">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="32"
                      height="32"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                      class="navigation__logo-icon"
                    >
                      <g
                        fill="none"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                      >
                        <path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881a1.79 1.79 0 0 1-.004-1.784L7.196 9.5M11 19h8.203a1.83 1.83 0 0 0 1.556-.89a1.78 1.78 0 0 0 0-1.775l-1.226-2.12"></path>
                        <path d="m14 16l-3 3l3 3m-5.707-8.404L7.196 9.5L3.1 10.598m6.244-4.787l1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.78 1.78 0 0 1 1.546.888l3.943 6.843"></path>
                        <path d="m13.378 9.633l4.096 1.098l1.097-4.096"></path>
                      </g>
                    </svg>
                    <span class="navigation__logo-text">SortSmart</span>
                  </div>
                </a>
                <button
                  id="navigation-toggle"
                  aria-expanded="false"
                  aria-controls="navigation-menu"
                  aria-label="Toggle navigation menu"
                  class="navigation__toggle"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    class="navigation-navigationtoggle-icon1 navigation__toggle-icon--open"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 5h16M4 12h16M4 19h16"
                    ></path>
                  </svg>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                    class="navigation-navigationtoggle-icon2 navigation__toggle-icon--close"
                  >
                    <path
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 6l12 12M6 18L18 6"
                    ></path>
                  </svg>
                </button>
                <div id="navigation-menu" class="navigation__menu">
                  <ul class="navigation__list">
                    <li class="navigation__item">
                      <a href="categories.html">
                        <div class="navigation__link">
                          <span>Recycling Categories</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="index.html#locations">
                        <div class="navigation__link">
                          <span>Find Nearby Locations</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="resources.html">
                        <div class="navigation__link">
                          <span>Resource Links</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item">
                      <a href="photo-recognition.html">
                        <div class="navigation__link">
                          <span>Photo Recognition</span>
                        </div>
                      </a>
                    </li>
                    <li class="navigation__item navigation__item--cta">
                      <a href="chatbot.html">
                        <div class="navigation__cta btn btn-primary">
                          <span>AI Chatbot</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </nav>
            <div class="navigation-container2">
              <div class="navigation-container3">
                <style>
                  @media (prefers-reduced-motion: reduce) {
                    * {
                      animation-duration: 0.01ms !important;
                      animation-iteration-count: 1 !important;
                      transition-duration: 0.01ms !important;
                    }
                  }
                </style>
              </div>
            </div>
            <div class="navigation-container4">
              <div class="navigation-container5">
                <script defer data-name="navigation">
                  document.addEventListener('DOMContentLoaded', function() {
                    (function(){
                      const navigationToggle = document.getElementById("navigation-toggle");
                      const navigationMenu = document.getElementById("navigation-menu");
                      const navigation = document.getElementById("main-navigation");

                      if (navigationToggle && navigationMenu) {
                        navigationToggle.addEventListener("click", function () {
                          const isExpanded = navigationToggle.getAttribute("aria-expanded") === "true";
                          navigationToggle.setAttribute("aria-expanded", !isExpanded);
                          navigationMenu.classList.toggle("navigation__menu--open");
                          document.body.style.overflow = !isExpanded ? "hidden" : "";
                        });

                        // Close when clicking backdrop on mobile
                        navigationMenu.addEventListener("click", function (e) {
                          if (e.target === navigationMenu && navigationMenu.classList.contains("navigation__menu--open")) {
                            navigationToggle.setAttribute("aria-expanded", "false");
                            navigationMenu.classList.remove("navigation__menu--open");
                            document.body.style.overflow = "";
                          }
                        });

                        // Close when selecting a link on mobile
                        const navigationLinks = navigationMenu.querySelectorAll(".navigation__link");
                        navigationLinks.forEach(function (link) {
                          link.addEventListener("click", function () {
                            if (window.innerWidth <= 991) {
                              navigationToggle.setAttribute("aria-expanded", "false");
                              navigationMenu.classList.remove("navigation__menu--open");
                              document.body.style.overflow = "";
                            }
                          });
                        });

                        // Reset menu state on resize
                        let resizeTimer;
                        window.addEventListener("resize", function () {
                          clearTimeout(resizeTimer);
                          resizeTimer = setTimeout(function () {
                            if (window.innerWidth > 991) {
                              navigationToggle.setAttribute("aria-expanded", "false");
                              navigationMenu.classList.remove("navigation__menu--open");
                              document.body.style.overflow = "";
                            }
                          }, 150);
                        });
                      }

                      // Add scroll enhancement class
                      window.addEventListener("scroll", function () {
                        const currentScroll = window.pageYOffset;
                        if (currentScroll > 50) {
                          navigation.classList.add("navigation--scrolled");
                        } else {
                          navigation.classList.remove("navigation--scrolled");
                        }
                      });

                      // Escape to close
                      document.addEventListener("keydown", function (e) {
                        if (e.key === "Escape" && navigationMenu.classList.contains("navigation__menu--open")) {
                          navigationToggle.setAttribute("aria-expanded", "false");
                          navigationMenu.classList.remove("navigation__menu--open");
                          document.body.style.overflow = "";
                          navigationToggle.focus();
                        }
                      });
                    })();
                  });
                </script>
              </div>
            </div>
          </div>
        </navigation-wrapper>
      </div>
    </div>

  <main class="resources-container categories-layout" style="padding-top: 2rem; max-width: 1100px; margin: 0 auto;">
      <header class="resources-content" style="margin-bottom: 1.5rem;">
        <h1>Recycling categories</h1>
        <p class="lead">Pick a material, then search items in that category.</p>
      </header>

      <section class="search-category-container">
        <div class="search-panel">
          <form id="category-search-form" class="quick-search-form">
            <input
              type="search"
              id="category-search-input"
              placeholder="Search items (e.g., bottle, battery...)"
              aria-label="Search items by name"
              aria-describedby="category-search-help"
              disabled
            />
            <button type="submit" class="btn btn-primary" disabled>Search</button>
          </form>
          <span id="category-search-help" class="search-help">
            Select a category first to enable search.
          </span>
        </div>

        <div class="categories-grid" id="categories-grid" style="margin-top: 1rem;">
          <!-- Categories will be injected here -->
        </div>
      </section>

      <section style="margin-top: 2rem;">
        <h2>Results</h2>
        <ul id="results-list" style="list-style: none; padding: 0; margin-top: 0.5rem;">
          <!-- Item results will be injected here -->
        </ul>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Navigation toggle (same behavior as index.html)
        const navigationToggle = document.getElementById("navigation-toggle");
        const navigationMenu = document.getElementById("navigation-menu");
        if (navigationToggle && navigationMenu) {
          navigationToggle.addEventListener("click", function () {
            const isExpanded =
              navigationToggle.getAttribute("aria-expanded") === "true";
            navigationToggle.setAttribute("aria-expanded", !isExpanded);
            navigationMenu.classList.toggle("navigation__menu--open");
            document.body.style.overflow = !isExpanded ? "hidden" : "";
          });
          navigationMenu.addEventListener("click", function (e) {
            if (
              e.target === navigationMenu &&
              navigationMenu.classList.contains("navigation__menu--open")
            ) {
              navigationToggle.setAttribute("aria-expanded", "false");
              navigationMenu.classList.remove("navigation__menu--open");
              document.body.style.overflow = "";
            }
          });
        }

        const grid = document.getElementById('categories-grid');
        const results = document.getElementById('results-list');
        const form = document.getElementById('category-search-form');
        const input = document.getElementById('category-search-input');
        const submitBtn = form.querySelector('button');

        let selectedCategoryId = null;

        function setSearchEnabled(enabled) {
          input.disabled = !enabled;
          submitBtn.disabled = !enabled;
          document.getElementById('category-search-help').textContent =
            enabled ? 'Type and submit to search items in the selected category.' :
                      'Select a category first to enable search.';
          if (enabled) {
            input.focus();
          }
        }

        function renderCategories(data) {
          grid.innerHTML = '';
          data.forEach((row) => {
            // API returns dicts with keys from MySQL DictCursor
            const id = row.id;
            const name = row.name;

            const btn = document.createElement('button');
            btn.className = 'category-button';
            btn.setAttribute('role', 'button');
            btn.setAttribute('aria-label', `Browse ${name} category`);
            btn.setAttribute('aria-pressed', 'false');

            const wrapper = document.createElement('div');
            wrapper.className = 'category-content';
            const h3 = document.createElement('h3');
            h3.textContent = name || 'Unknown material';
            const p = document.createElement('p');
            p.textContent = 'Search items in this material';
            wrapper.appendChild(h3);
            wrapper.appendChild(p);

            btn.appendChild(wrapper);
            btn.addEventListener('click', () => {
              selectedCategoryId = id;
              Array.from(grid.querySelectorAll('.category-button')).forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
              });
              btn.classList.add('active');
              btn.setAttribute('aria-pressed', 'true');
              setSearchEnabled(true);
              // Initial load of items in the category (no query)
              fetchResults('');
            });

            grid.appendChild(btn);
          });
        }

        function renderResults(items) {
          results.innerHTML = '';
          if (!items.length) {
            const li = document.createElement('li');
            li.textContent = 'No items found.';
            results.appendChild(li);
            return;
          }
          items.forEach((row) => {
            // item_search returns dicts: {id, name, notes, default_stream, material_id}
            const name = row.name;
            const notes = row.notes || '';
            const stream = row.default_stream || '';

            const li = document.createElement('li');
            li.style.padding = '0.5rem 0';
            li.style.borderBottom = '1px solid var(--color-outline, #eee)';
            li.innerHTML = `
              <strong>${name}</strong>
              <div style="font-size: .9rem; color: var(--color-on-surface-variant, #666);">
                ${notes ? notes : ''} ${stream ? `(default: ${stream})` : ''}
              </div>
            `;
            results.appendChild(li);
          });
        }

        async function fetchResults(q) {
          if (!selectedCategoryId) return;
          const params = new URLSearchParams();
          if (q) params.set('q', q);
          params.set('material_id', String(selectedCategoryId));
          const res = await fetch('/api/item_search?' + params.toString());
          const data = await res.json();
          renderResults(data);
        }

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          if (!selectedCategoryId) return;
          fetchResults(input.value.trim());
        });

        // Load categories
        (async function init() {
          try {
            const res = await fetch('/api/categories');
            const data = await res.json();
            renderCategories(data);
          } catch (e) {
            grid.innerHTML = '<p>Failed to load categories.</p>';
          }
        })();
      });
    </script>
  </body>
</html>